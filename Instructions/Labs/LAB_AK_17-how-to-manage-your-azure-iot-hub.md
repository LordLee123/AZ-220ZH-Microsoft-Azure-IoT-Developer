---
lab:
    title: '实验室 17：如何管理你的 Azure IoT 中心'
    module: '模块 9：解决方案测试、诊断和记录'
---

# 如何管理你的 Azure IoT 中心

## 实验室场景

Contoso 的资产监视和跟踪解决方案运行良好。该系统在整个包装和运输过程中提供持续监控。你已经在 DPS 中实现了组注册，以大规模预配设备，并且当集装箱到达目的地时，IoT 设备通过 DPS“解除授权”，以便可以将其重新用于以后的装运。

为了帮助管理设备利用率和解决方案的其他特征，IT 部门已要求你的团队在 IoT 解决方案中实现 Azure 监视和日志记录服务。

你同意首先实现一些简单的指标，这些指标可以在你承担任何其他工作负荷之前由 IT 人员进行审查。

在本实验室中，你将实现监视以跟踪已连接设备和已发送遥测消息的数量，以及将连接事件发送到日志。另外，你将创建一个警报，该警报将基于连接的平均设备数触发。要测试系统，你将配置 10 个模拟的 IoT 设备，这些设备将使用在根 CA 证书链上生成的设备 CA 证书向 DPS 进行身份验证。IoT 设备将配置为将遥测发送到 IoT 中心。

将创建以下资源：

![实验室 17 体系结构](media/LAB_AK_17-architecture.png)

## 本实验室概览

在本实验室中，你将完成以下活动：

* 验证实验室先决条件
* 启用诊断日志。
* 启用指标。
* 为这些指标设置警报。
* 下载并运行一个应用，该应用模拟通过 X.509 连接并将消息发送到中心的 IoT 设备。
* 运行应用，直到开始触发警报。
* 查看指标结果并检查诊断日志。

## 实验室说明

### 练习 1：验证实验室先决条件

本实验室假定以下 Azure 资源可用：

| 资源类型 | 资源名称 |
| :-- | :-- |
| 资源组 | AZ-220-RG |
| IoT 中心 | AZ-220-HUB-{YOUR-ID} |
| 设备预配服务 | AZ-220-DPS-{YOUR-ID} |
| 存储帐户 | az220storage{your-id} |

如果这些资源不可用，则需要在继续练习 2 之前请按照以下说明运行 **lab17-setup.azcli** 脚本。脚本文件包含在本地克隆作为开发环境配置（实验室 3）的 GitHub 存储库中。

**lab17-setup.azcli** 脚本编写为在 **bash** shell 环境中运行，执行此操作的最简单方法是在 Azure Cloud Shell 中进行。

1. 使用浏览器，打开 [Azure Cloud Shell](https://shell.azure.com/)，并使用本课程使用的 Azure 订阅登录。

    如果系统提示设置 Cloud Shell 的存储，请接受默认设置。

1. 验证 Azure Cloud Shell 是否正在使用 **Bash**。

1. 在 Azure Shell 工具栏上，单击**上传/下载文件** （从右数第四个按钮）。

1. 在下拉菜单中，单击 **“上传”**。

1. 在“文件选择”对话框中，导航到配置开发环境时下载的 GitHub 实验室文件的文件夹位置。

    在_实验室 3 中：设置开发环境_，你可以通过下载 ZIP 文件并从本地提取内容来克隆包含实验室资源的 GitHub 存储库。提取的文件夹结构包括以下文件夹路径：

    * Allfiles
      * 实验室
          * 17 - 如何管理 Azure IoT 中心
            * 设置

    lab17-setup.azcli 脚本文件位于实验室 17 的配置文件夹中。

1. 选择 **lab17-setup.azcli** 文件，然后单击 **“打开”**。

    文件上传完成后，将显示一条通知。

1. 若要验证在 Azure Cloud Shell 中已上传了正确文件，请输入以下命令：

    ```bash
    ls
    ```

    使用 `ls` 命令列出当前目录的内容。你应该看到列出的 lab17-setup.azcli 文件。

1. 若要为此实验室创建一个包含安装脚本的目录，然后移至该目录，请输入以下 Bash 命令：

    ```bash
    mkdir lab17
    mv lab17-setup.azcli lab17
    cd lab17
    ```

1. 为了确保 **lab17-setup.azcli** 脚本具有执行权限，请输入以下命令：

    ```bash
    chmod +x lab17-setup.azcli
    ```

1. 在 Cloud Shell 工具栏上，要编辑 lab17-setup.azcli 文件，请单击 **“打开编辑器”** （右侧的第二个按钮 - **{ }**）。

1. 在 **“文件”** 列表中，展开 lab17 文件夹并打开脚本文件，单击 **“lab17”**，然后单击 **“lab17-setup.azcli”**。

    编辑器现在将显示 **lab17-setup.azcli** 文件的内容。

1. 在编辑器中，更新 `{YOUR-ID}` 和 `{YOUR-LOCATION}` 变量的值。

    以下面的示例为例，需要将 `{YOUR-ID}` 设置为在本课程开始时创建的唯一 ID，即 **CAH191211**，然后将 `{YOUR-LOCATION}` 设置为对你的资源有意义的位置。

    ```bash
    #!/bin/bash

    YourID="{YOUR-ID}"
    RGName="AZ-220-RG"
    IoTHubName="AZ-220-HUB-$YourID"
    DPSName="AZ-220-DPS-$YourID"
    DeviceName="asset-track"
    Location="{YOUR-LOCATION}"
    ```

    > **注释**：  `{YOUR-LOCATION}` 变量应设置为该区域的短名称。输入以下命令，可以看到可用区域及其短名称的列表（**名称**列）：
    >
    > ```bash
    > az account list-locations -o Table
    >
    > DisplayName           Latitude    Longitude    Name
    > --------------------  ----------  -----------  ------------------
    > 东亚            22.267      114.188      eastasia
    > 东南亚       1.283       103.833      southeastasia
    > 美国中部            41.5908     -93.6208     centralus
    > 美国东部               37.3719     -79.8164     eastus
    > East US 2             36.6681     -78.3889     eastus2
    > ```

1. 要保存对文件所做的更改并关闭编辑器，请单击编辑器窗口右上角的 **“...”**，然后单击 **“关闭编辑器”**。

    如果提示保存，请单击 **“保存”**，编辑器将会关闭。

    > **注释**：  可以使用 **CTRL+S** 随时保存，使用 **CTRL+Q** 关闭编辑器。

1. 要创建本实验室所需的资源，请输入以下命令：

    ```bash
    ./lab17-setup.azcli
    ```

    运行此脚本可能需要几分钟。每个步骤完成时，你将会看到 JSON 输出。

    该脚本将首先创建一个名为 **“AZ-220-RG”** 的资源组，然后将你的 IoT 中心命名为 **“AZ-220-HUB-{YourID}”**，并将设备预配服务命名为 **“AZ-220-DPS-{YourID}”**。如果服务已经存在，将显示相应的消息。该脚本将链接你的 IoT 中心和 DPS。然后，脚本将创建一个名为 **“az220storage{your-id}”** 的存储帐户。

    现在，你应该可以继续进行本实验室的练习 2。

### 练习 2：通过 IoT 中心设置和使用指标和诊断日志

Azure 资源日志是 Azure 资源发出的描述其内部操作的平台日志。所有资源日志共享一个通用的顶级架构，每个服务都可以灵活地为自己的事件发出独特的属性。

如果有 IoT 中心解决方案在生产中运行时，你需要设置各种指标并启用诊断日志。然后，如果出现问题，则可以查看数据，这将有助于你诊断问题并更快地解决问题。

在本练习中，你将启用诊断日志并使用它们来检查错误。你还将设置一些要监视的指标，并在指标达到特定边界值时发出警报。

#### 任务 1：启用诊断

1. 如有必要，请使用 Azure 帐户凭据登录到 Azure 门户。

    如果有多个 Azure 帐户，请确保使用与该课程将使用的订阅绑定的帐户登录。

1. 在 Azure 仪表板上，单击 **AZ-220-HUB-{YOUR-ID**。

    你的仪表板应在 AZ-220-RG 资源组磁贴上具有指向 IoT 中心的链接。

1. 在左侧导航菜单中，在 **“监视”** 下，单击 **“诊断设置”**。

    > **注释**：当前文档建议默认情况下可能禁用“诊断”。如果是这样，你可能需要“打开诊断”才能为 IoT 中心收集诊断数据。当你单击 **“打开诊断”** 时，**“诊断设置”** 边栏选项卡将打开。

1. 在 **“诊断设置”** 窗格的 **“名称”** 下，单击 **“添加诊断设置”**。

1. 在 **“诊断设置名称”** 文本框中，输入 **“diags-hub”**

1. 花一点时间查看 **“目标详细信息”** 下面列出的选项。

    你会看到有 3 个可用于路由指标的选项 - 你可以通过以下链接了解每个指标的详细信息：

    * [将 Azure 资源日志存档到存储帐户](https://docs.microsoft.com/zh-cn/azure/azure-monitor/platform/resource-logs-collect-storage)
    * [将 Azure 监视数据流式传输到事件中心](https://docs.microsoft.com/zh-cn/azure/azure-monitor/platform/stream-monitoring-data-event-hubs)
    * [在 Azure Monitor 的 Log Analytics 工作区中收集 Azure 资源日志](https://docs.microsoft.com/zh-cn/azure/azure-monitor/platform/resource-logs-collect-workspace)

    在本实验室中，我们将使用存储帐户选项。

1. 在 **“目标详细信息”** 下，单击 **“存档到存储帐户”**。

    选择此目标选项后，其他字段将变为可用，包括用于指定日志类别的 **“保留期(天)”** 的选项。

    > **注释**：花一点时间查看有关存储帐户和成本的备注。

1. 对于 **“订阅”** 字段，请选择用于创建 IoT 中心的订阅。

1. 对于 **“存储帐户”** 字段，请选择 **az220storage{your-id}** 存储帐户。

    该帐户是由 lab17-setup.azcli 脚本创建的。如果下拉列表中未列出该帐户，则可能需要手动创建一个帐户（请与你的讲师联系）。

1. 在 **“诊断设置”** 边栏选项卡的 **“类别详细信息”** 下，单击 **“连接”**，然后单击 **“DeviceTelemetry”**。

1. 对于你选择的每个日志类别，在 **“保留期(天)”**字段中，输入 **“7”** 

1. 在边栏选项卡顶部，单击 **“保存”**，然后关闭边栏选项卡

    你现在应该处于 IoT 中心的 **“诊断设置”** 窗格中，并应该看到 **“诊断设置”** 已更新，用以显示你刚刚创建的 **“diags-hub”** 设置。

    稍后，当你查看诊断日志时，你将能够看到设备的连接和断开日志记录。

#### 任务 2：设置指标

在本任务中，你将设置各种指标，以监视何时将消息发送到你的 IoT 中心。

1. 确保已打开 IoT 中心边栏选项卡。

    在上一任务结束时，你停留在 IoT 中心边栏选项卡的 **“诊断设置”** 窗格。

1. 在左侧导航菜单中，在 **“监控”** 下方，单击 **“指标”** 。

    将显示一个显示新的空图表的 **“指标”** 窗格。

1. 在屏幕右上角，要更改图表的时间范围和时间粒度，请单击 **“过去 24 小时（自动）”**。

1. 在出现的上下文菜单的 **“时间范围”** 下，单击 **“过去 4 小时”**。

1. 在同一上下文菜单中的 **“时间粒度”** 下，单击 **“1 分钟”**，并在 **“显示时间为”** 下，确保选中 **“本地”**。

1. 要保存你的时间设置，请单击 **“应用”**。

1. 花一分钟时间检查用于指定图表指标的设置。

    在 **“图表标题”** 和图表工具栏下，你将看到一个指定指标的区域。 

    * 请注意，**“范围”** 已经设置为 **“AZ-220-HUB-{YOUR-ID}”**。
    * 请注意，**“指标命名空间”** 已经设置为 **“IoT 中心标准指标”**。

    > **注释**：默认情况下，只有一个指标命名空间可用。命名空间是一种将相似指标进行分类或分组到一起的方法。通过使用命名空间，你可以在可能收集不同见解或性能指标的各组指标之间实现隔离。例如，你可能有一个名为 **“az220memorymetrics”** 的命名空间，用于跟踪应用配置文件的内存使用指标。另一个命名空间称为 **“az220apptransaction”** 可能会跟踪有关应用程序中用户交易的所有指标。你可以在[此处](https://docs.microsoft.com/zh-cn/azure/azure-monitor/platform/metrics-custom-overview?toc=%2Fazure%2Fazure-monitor%2Ftoc.json#namespace)了解有关自定义指标和命名空间的更多信息。

    接下来的步骤是添加一个指标，用于监控已发送到 IoT 中心的遥测消息的数量。

1. 在 **“指标”** 下拉列表中，单击 **“已发送遥测信息”**。

    请注意，你可以从中选择大量指标！

1. 在 **“聚合”** 下，确保选中 **“总和”**。

    请注意，有 4 个聚合操作可用 - *平均值*、*最小值*、*最大值* 和 *总和*。

1. 请花费片刻时间查看你的图表。

    请注意，图表标题已更新以体现所选的指标。

    你已完成对第一个指标的说明。接下来，你将添加另一个指标来监视连接的设备数量。

1. 在图表标题的工具栏上，单击 **“添加指标”**。

    将会出现一个新指标。请注意， **“范围”** 和 **“指标命名空间”** 值已预先填充。

1. 在 **“指标”** 下拉列表中，单击 **“已连接的设备(预览)”**。

1. 在 **“聚合”** 下，确保选中 **“平均值”**。

    你的屏幕现在显示发送的遥测消息的最小指标，以及平均连接设备的新指标。请注意，图表标题已更新以反映两个指标。

    > **注释**：要编辑图表标题，请单击标题右侧的 **铅笔**。

1. 在工具栏右侧的 **“图表标题”** 下，单击 **“固定到仪表板”**，然后单击 **“固定到当前仪表板”**

    > **注释**： 为了保留刚创建的图表，**必须** 将其固定到仪表板上。

1. 导航到 “AZ-220” 仪表板，并确认已显示该图表。

    > **注释**：你可以使用拖放操作来自定义图表的大小和位置。

现在，你已启用日志记录并设置图表以监控指标，现在是设置警报的好时机。

### 练习 3：配置警报

警报用于在监控数据中发现重要情况时主动通知你。它们允许你在系统用户注意到之前识别并解决问题。 

在你的资产跟踪方案中，你使用传感器来跟踪要配送给客户的容器。每次在装运容器中添加传感器时，都会通过 DPS 自动配置传感器。 

对于即将进行的概念验证演示，你希望创建一个警报，在当前正在传输的容器数量接近容量限制时触发。要触发警报，你将使用 IoT 中心的“已连接设备”事件数量。

在本练习中，你将添加一个将在连接 5 个或更多设备时触发的警报。

1. 在 Azure 门户窗口中打开“IoT 中心”边栏选项卡。

1. 在左侧导航菜单的 **“监控”** 下，单击 **“警报”**。

    将显示空的 **“警报”** 页。请注意，**“订阅”**、**“资源组”**、**“资源”** 和 **“时间范围”** 字段已预先填充。

1. 在 **“时间范围”** 下拉列表中，单击 **“过去一个小时”**。

1. 在 **“警报”** 窗格顶部，单击 **“新建警报规则”**

    此时应显示 **“创建规则”** 边栏选项卡。

1. 花点时间查看 **“创建规则”** 边栏选项卡。

    边栏选项卡顶部有两个字段： **“资源”** 和 **“层次结构”**。请注意，这些字段已预填充 IoT 中心的属性。如果需要更改预先选择的资源，请单击“资源”下的 **“选择”**。

1. 在 **“条件”** 下，单击 **“添加”**。

    此时应显示 **“配置信号逻辑”** 窗格。请注意，显示了可用信号的分页表。表格上方的字段用于筛选表格，以帮助查找所需的信号类型。

1. 在 **“信号类型”** 下，确保选中 **“全部”**。

    如果打开“信号类型”下拉列表，则会看到有 3 个可用选项： *“全部”*、*“指标”* 和 *“活动日志”*。

    > **注释**：用于监测的信号类型因所选目标而异。信号类型可以是指标，日志搜索查询或活动日志。

1. 在 **“监视器服务”** 下，确保选中 **“全部”**。

    如果打开“监视服务”下拉菜单，你会看到有 3 个可用选项： *“所有”*、*“平台”* 和 *“活动日志 - 管理”*。

    > **注释**： 平台服务提供有关服务利用率的指标，活动日志跟踪管理活动。

1. 在 **“按信号名称搜索”** 文本框中，键入 **“已连接”**

1. 请注意，信号列表会根据你的输入立即进行筛选。

1. 在 **“信号名称”** 下，单击 **“连接的设备(预览)”**。

    窗格将更新以显示与你为 **“指标”** 创建的图表类似的图表。图表显示与选定信号相关的值（在本例中为 *已连接设备（预览）*）。

    图表下方是定义 **“警报逻辑”** 的区域。

1. 花些时间查看 **“警报逻辑”** 下的选项

    注意，**阈值**有两个可能的选择 - *静态* 和 *动态*。另请注意，**静态** 处于选中状态，而 **动态** 不适用于该信号类型。

    > **注释**：  顾名思义， *静态阈值* 为阈值指定一个常量表达式，而 *动态阈值* 检测利用高级机器学习 (ML) 来学习指标的历史行为，识别指示可能的服务问题的模式和异常。你可以在[此处](https://docs.microsoft.com/zh-cn/azure/azure-monitor/platform/alerts-dynamic-thresholds)详细了解 *动态阈值*。

    我们将创建一个静态阈值，它会在每次 *“连接的设备数(预览)”* 信号等于或大于 5 时触发警报。

1. 在 **“运算符”** 下拉菜单中，单击 **“大于或等于”**。

    你可能需要记录此字段和其他字段的其他选项。

1. 在 **“聚合类型”** 选项下，确保 **“平均值”** 已选定。

1. 在 **“阈值”** 文本框中，输入 **“5”**

    > **注释**： **“条件预览”** 向你显示用于刷新显示内容的条件，显示内容会根据你输入的“运算符”、“聚合类型”和“阈值”设置来进行刷新。 **“条件预览”** 下面是 **“评估依据”** 区域。这些值确定使用上面选择的 **“聚合类型”** 聚合的历史时间段，以及评估条件的频率。

1. 在 **“聚合粒度(周期)”** 下，确保选择 **“5 分钟”**。

1. 在 **“评估频率”** 下，确保选择 **“每 1 分钟”**。

    > **注释**：由于 **计算频率** 要比 **聚合粒度（周期）** 短，这会导致出现滑动窗口计算。这意味着前 5 分钟内每分钟的值都将被聚合（在此情况下，被平均），然后针对条件进行计算。一分钟后，前 5 分钟的数据将再次聚合 - 包括一分钟的新数据和四分钟的已计算数据。因此，滑动窗口每次向前移动一分钟，但始终包含 4 分钟在上一个窗口已计算的数据。

1. 若要配置警报条件，请在 **“配置信号逻辑”** 窗格的底部，单击 **“完成”**。

    **“配置信号逻辑”** 窗格关闭，并显示 **“创建规则”** 边栏选项卡。请注意， **“条件”** 现已填充，并且显示 **“每月成本(美元)”**。写入时，警报条件的估计成本为 0.10 美元。

    接下来，你需要配置满足警报条件时采取的操作。

1. 花点时间查看一下 **“操作组(可选)”** 区域。 

    请注意，未选择任何操作组。有两种选择 - **添加** 和 **创建**。 

    > **注释**：操作组是 Azure 订阅的所有者定义的通知首选项的集合。操作组名称必须是关联的资源组内唯一的。Azure Monitor 和服务运行状况警报使用操作组通知用户已触发警报。根据用户要求，各种警报可使用相同操作组或不同操作组。你可以在一个订阅中最多配置 2,000 个操作组。你可以[在此](https://docs.microsoft.com/zh-cn/azure/azure-monitor/platform/action-groups)了解有关创建和管理操作组的更多信息。

1. 在 **“操作组(可选)”** 下，单击 **“创建”**。

    显示 **“添加操作组”** 边栏选项卡。

1. 在 **“操作组名称”** 下，输入 **AZ-220 电子邮件操作组**

    > **注释**：操作组名称在与其关联的资源组中必须是唯一的。

1. 在 **“简称”** 下，输入 **“AZ220EmailAG”**

    > **注释**：当使用此组发送通知时，将使用短名称代替完整的操作组名称，并且最大限制为 12 个字符。

1. 在 **“订阅”** 选项下，请确保你在本实验室中使用的订阅已选定。

1. 在 **“资源组”** 下拉列表中，单击 **“AZ-220-RG”**。

    > **注释**：操作组通常可在整个订阅范围内共享，并且可能由 Azure 订阅所有者集中管理。这样，它们更有可能包含在公共资源组中，而不是项目特定的资源组（例如“AZ-220-RG”）中。我们正在使用“AZ-220-RG”来简化实验室结束后清理资源的过程。

    下一个区域 **“操作”** 用于定义将在每次调用此操作组时执行的操作列表。

1. 在 **“操作名称”** 下，输入 **“AZ220Notifications”**

1. 打开 **“操作类型”** 下拉菜单，然后查看可用选项。

1. 在 **“操作类型”** 下拉菜单中，单击 **“电子邮件/短信/推送/语音”**。

    **“电子邮件/短信/推送/语音”** 边栏选项卡会立即显示此操作类型的操作详细信息。请注意，你最多可以选择 4 种传递通知的方法。

1. 在 **“电子邮件/短信/推送/语音”** 边栏选项卡上，单击 **“电子邮件”**，然后输入你可以轻松访问的电子邮件地址。 

1. 单击 **“短信”**，然后为你希望用于接收短信警报的手机输入 **“国家/地区代码”** 和 **“电话号码”**。

1. 跳过 **“Azure 应用推送通知”** 和 **“语音”**。

1. 在 **“启用通用警报架构”** 下，单击 **“是”**。

   > **注释**： 使用通用警报架构好处众多。它将当今 Azure 中警报通知的使用体验标准化。从历史上看，目前 Azure 中的三种警报类型（指标、日志和活动日志）一直都有各自的电子邮件模板、Webhook 架构等。现在，借助通用警报架构，你可以接收架构一致的警报通知。欲进一步了解通用 ALert6 架构，请点击[这里](https://docs.microsoft.com/zh-cn/azure/azure-monitor/platform/alerts-common-schema)。
   >
   > **重要事项：**鉴于通用警报架构有这么多好处，你可能在想为什么不设置为默认启用模式呢 - 嗯，那是因为当选择 **“是”** 时，你会看到一个警告 **“启用通用警报架构可能会破坏任何现有的集成”**。在自己的环境中请记住这点。

1. 在 **“电子邮件/短信/推送/语音”** 边栏选项卡底部，单击 **“确定”**，保存操作配置。

    **“添加操作组”** 边栏选项卡此时应列出你的操作。注意，如果需要更改，新操作有一个指向 **“编辑详细信息”** 的链接。

    此时，如果我们需要通过 *“WebHook”* 或 *“Azure 函数”* 启动一些业务集成，则可以添加多个操作，但对本实验室而言，一个简单的通知已经足够。

1. 在 **“添加操作组”** 边栏选项卡底部，单击 **“确定”** 创建此操作组。

    同时会发生一些事情。首先， **“添加操作组”** 边栏选项卡会关闭，你会留在 **“创建规则”** 边栏选项卡，且新的操作组已添加到 **“操作”** 列表。

    然后，你将很快收到一则短信通知和一封电子邮件，这两者都会通知你已被添加到 **“AZ220EmailAG”** 操作组。在短信中，你将注意到你可以回复此消息以停止接收今后的通知等（[可在此处](https://docs.microsoft.com/zh-cn/azure/azure-monitor/platform/alerts-sms-behavior)深入了解各种选项）。电子邮件中包含可以单击并查看操作组详细信息的链接，在电子邮件底部（在小字体处），可以看到取消订阅选项。

    接下来，你将配置 **警报详细信息**。

1. 在 **“创建规则”** 边栏选项卡的 **“警报规则名称”** 选项下，输入 **“已连接设备数大于或等于 5”**

    名称应具有充分的描述性，以便能够识别警报。

1. 在 **“描述”** 下，输入 **“当连接到 AZ-220-HUB-{YOUR-ID} 中心的设备数大于或等于 5 时，触发此警报”**。

    描述字段是可选的，但建议填写。

1. 在 **“严重性”**下，选择 **“严重性 3”**。

    在我们的情形下，此警报是*信息性的*，并不表示有任何严重故障，因此 **“严重性 3”** 是正确的选择。

    > **注释**：  严重性级别选项为：严重性 0 - 严重性 4。你的企业应该为各级别建立明确的定义。 
    >
    > 例如，Contoso 可能将这些级别定义如下：
    >* Sev 0 = 严重
    >* 严重性 1 = 错误
    >* 严重性 2 = 警告
    >* 严重性 3 = 信息
    >* 严重性 4 = 详细信息

1. 在 **“创建时启用规则”** 下，确保选中了 **“是”**。

    > **注释**： 指标警报规则最多可能需要 10 分钟才能生效。

1. 在边栏选项卡底部，单击 **“创建预警规则”**。

    现在应显示 IoT 中心的**“警报”** 窗格。中间的消息应该会告诉你没有警报，你应该会看到在该状态消息下面添加了一个 **“管理警报规则(1)”** 按钮。

现在是时候配置触发警报所需的环境了。

### 练习 4：模拟传感器

要模拟 Contoso 的资产跟踪系统，你需要模拟放置在装运集装箱中的 IoT 设备。激活每个设备后，应使用自动设备预配连接到 IoT 解决方案并开始发送遥测。为了自动连接，每个设备将需要自己的 X.509 证书，该证书是用于创建组注册的根证书的链的一部分。

在本练习中，你将验证现有环境，执行必要的设置，生成 10 个设备证书以及配置将模拟 10 个设备的控制台应用程序。

> **注释**：在本课程的实验室 6 中（**实验室 6 - DPS 中的设备自动注册**），你已配置 DPS 以使用 X.509 资源。如果你仍然可以使用该配置，则可以跳过以下一项或多项任务。

#### 任务 1：验证 DPS 配置

1. 在浏览器中，导航到 [“Azure 门户”](https://portal.azure.com/)，并登录你的订阅。

1. 在仪表板上，检查“AZ-220-RG”资源组磁贴，以了解 **AZ-220-DPS-{YOUR-ID}** 设备预配服务。

    > **注释**： 如果 **AZ-220-DPS-{YOUR-ID}** 不存在，请返回本实验室中的练习 1 并运行设置脚本。

1. 在资源组磁贴上，单击 **“AZ-220-DPS-{YOUR-ID}”**。

1. 在左侧导航菜单中，在 **“设置”** 下单击 **“证书”**。

1. 这会打开 **“证书”** 窗格，然后请按照以下说明操作：

    * 如果证书列表为空，请直接转到本练习的任务 2 - **任务 2： 验证 OpenSSL**。
    * 如果已列出名为 **root-ca-cert** 的证书，请继续下一步。 

1. 对于列出的证书，请检查 **“状态”** 下面的值，并按照以下说明进行操作： 

    * 如果证书状态为 **“未验证”**：
        * 单击证书以查看详细信息，然后单击 **“删除”**。 
        * 输入**“证书名称”** 确认删除，然后单击 **“确定”**。 
        * 直接前往本练习的任务 2 - **任务 2：验证 OpenSSL**。
    * 如果证书状态为 **“已验证”**，请继续进行下一步。

1. 在左侧导航菜单中，在**“设置”** 下，单击 **“管理注册”**

1. 在 **“管理注册”** 窗格，单击 **注册组**，以查看 DPS 中的注册组列表。

1. 如果列出了 **simulated-devices** 注册组，请直接进入下一个练习 - **练习 5：模拟设备**

1. 如果 **simulated-devices** 注册组不存在，请按照以下说明进行操作：

    * 如果你有名为 **root-ca-cert** 的经验证的证书，请直接转到本练习的任务 5 - **任务 5：创建注册组**。
    * 如果你在上面没有找到已验证证书，请继续执行任务 2 - **任务 2：验证 OpenSSL**。

#### 任务 2：验证 OpenSSL

在以下步骤中，你将验证在上一个实验室中安装的 OpenSSL 工具仍然可用。

1. 在浏览器中，导航到 [“Azure Shell”](https://shell.azure.com/)并登录到你的订阅。

1. 在 shell 提示符下，输入以下命令：

    ```bash
    cd ~/certificates
    ```

    如果你看到一个错误，指出**无此文件或目录**，请直接前往本练习的任务 3 - **任务 3：安装 OpenSSL 工具**。

1. 在 Cloud Shell 命令提示符下，输入以下命令：

    ```bash
    cd certs
    ```

    如果你看到一个错误，指出 **“无此文件或目录”**，请直接转到本练习的任务 4 - **任务 4：使用 OpenSSL 生成和配置 x.509 CA 证书**。

1. 如果 **certs** 文件夹可用，请直接转到本练习的任务 5 - **任务 5：创建注册组**。

#### 任务 3：安装 OpenSSL 工具

1. 在 Cloud Shell 中，输入以下命令：

    ```bash
    mkdir ~/certificates

    ＃导航到证书目录
    cd ~/certificates

    # 下载帮助程序脚本文件
    curl https://raw.githubusercontent.com/Azure/azure-iot-sdk-c/master/tools/CACertificates/certGen.sh --output certGen.sh
    curl https://raw.githubusercontent.com/Azure/azure-iot-sdk-c/master/tools/CACertificates/openssl_device_intermediate_ca.cnf --output openssl_device_intermediate_ca.cnf
    curl https://raw.githubusercontent.com/Azure/azure-iot-sdk-c/master/tools/CACertificates/openssl_root_ca.cnf --output openssl_root_ca.cnf

    ＃更新脚本权限，以便用户可以读取、写入和执行它
    chmod 700 certGen.sh
    ```

### 任务 4：使用 OpenSSL 生成和配置 x.509 CA 证书

所需的第一批 X.509 证书是 CA 和中间证书。可以通过传递 `create_root_and_intermediate` 选项并使用 `certGen.sh` 帮助程序脚本来生成它们。

1. 在 Cloud Shell 中，确保你位于 `~/certificates` 目录中。 

1. 在 Cloud Shell 命令提示符处，要生成 CA 和中间证书，请输入以下命令：

    ```sh
    ./certGen.sh create_root_and_intermediate
    ```

    该命令会生成一个名为 `azure-iot-test-only.root.ca.cert.pem` 的 CA 根证书，并将其放置在 `./certs` 目录中。

1. 在 Cloud Shell 命令提示符下，输入以下命令以将 `azure-iot-test-only.root.ca.cert.pem` 证书下载到本地计算机（以便可以将其上传到 DPS）：

    ```sh
    download ~/certificates/certs/azure-iot-test-only.root.ca.cert.pem
    ```

1. 在 Azure 门户中，打开 **AZ-220-DPS-{YOUR-ID}** 设备预配服务。

1. 在 **“设备预配服务”** 边栏选项卡上，在左侧导航菜单的 **“设置”** 选项下，单击 **“证书”**。

1. 在边栏选项卡顶部的 **“证书”** 窗格上，单击 **“添加”**。

    > **注释**： 如果看到存在现有证书，请选择并删除它。

1. 在 **“添加证书”** 窗格上，在 **“证书 .pem 或 .cer 文件”** 上传字段中选择 x.509 CA 证书文件。  

    这是刚刚下载的 `azure-iot-test-only.root.ca.cert.pem` CA 证书。

1. 在 **“证书名称”** 字段中，输入 **“root-ca-cert”**

    该名称可以与证书文件的名称相同，也可以不同。这是一个逻辑名称，与 x.509 CA 证书中的_公用名_没有关联。

1. 单击 **“保存”**。

    上传 x.509 CA 证书后，**“证书”** 窗格将显示 **“状态”** 为 **“未验证”** 的证书。在使用此 CA 证书对 DPS 的设备进行身份验证之前，你需要验证证书的 **“所有权证明”**。

1. 要开始验证证书的“所有权证明”，请单击 **“root-ca-cert”**。

1. 在 **“证书详细信息”** 窗格中，单击 **“生成验证码”**。

1. 复制新生成 **的验证码** 值。

    > **注释**： 生成验证证书时，你需要将 **“证书详细信息”** 窗格保持为 **“打开”** 状态。如果你关闭窗格，验证码就会失效，需要生成新的验证码。

1. 如果仍然无法在之前的基础上打开，则打开 **Azure Cloud Shell**，并导航到 `~/certificates` 目录。

    CA **证书的所有权证明** 是通过上传从 CA 证书生成的证书（其中包含刚在 DPS **中生成的验证代码**）提供给 DPS 的。这是如何证明你实际拥有 CA 证书的方法。

1. 在 Cloud Shell 命令提示符处，要创建 **验证证书** （提供 **验证码**），请输入以下命令：

    ```sh
    ./certGen.sh create_verification_certificate <verification-code>
    ```

    请务必将 `<verification-code>` 占位符替换为由 Azure 门户生成的 **验证码**。

    例如，命令运行会类似于：

    ```sh
    ./certGen.sh create_verification_certificate 49C900C30C78D916C46AE9D9C124E9CFFD5FCE124696FAEA
    ```

    该命令会生成一个通过验证码链接到 CA 证书的 **验证证书**。生成的名为 `verification-code.cert.pem` 的验证证书位于 Azure Cloud Shell 的 `./certs` 目录中。

1. 在 Cloud Shell 命令提示符下，要将此 **验证证书** 下载到本地计算机（以便将其上传到 DPS），请输入以下命令：

    ```sh
    下载 ~/certificates/certs/verification-code.cert.pem
    ```

1. 在 Azure 门户中，导航回 **“CA 证书”** 的 **“证书详细信息”** 窗格。

1. 在 **“验证证书 .pem 或 .cer 文件”** 字段，单击 **“verification-code.cert.pem”**。

    这是你新创建并下载的 **验证证书** 文件。

1. 在 **“证书详细信息”** 窗格中，单击 **“验证”**。

    完成 CA 证书的 **所有权证明** 后，请注意，**“证书”** 窗格中证书的 **“状态”** 现在显示为 **“已验证”**。

#### 任务 5：创建一个注册组

1. 在 Azure 门户中，确保 **“AZ-220-DPS-{YOUR-ID}”** 设备预配服务边栏选项卡处于打开状态。

1. 在左侧导航菜单的 **“设置”** 下，单击 **“管理注册”**。

    不应列出任何注册组。
 
1. 在边栏选项卡顶部，单击 **“添加注册组”**。

1. 在 **“添加注册组”** 边栏选项卡中，在 **“组名称”** 字段中输入 **“simulated-devices”**

1. 确保将 **“认证类型”** 设置为 **“证书”**。

1. 确保将 **“证书类型”** 字段设置为 **“CA 证书”**。

1. 在 **“初级证书”** 下拉列表中，单击 **“root-ca-cert”**。

    验证 **“选择可以分配给该组的 IoT 中心”** 下拉菜单中是否包括你的 **“AZ-220-HUB-_{YOUR-ID}_”** IoT 中心。这将确保在预配设备时将其添加到此 IoT 中心。

1. 在 Initial Device Twin State 字段中，修改 `properties.desired` JSON 对象以包括名为 `telemetryDelay` 的属性，其值为 `"1"`。设备将使用它设置读取传感器遥测并向 IoT 中心发送事件的时间延迟。

    最终的 JSON 如下所示：

    ```js
    {
        "tags": {},
        "properties": {
            "desired": {
                "telemetryDelay": "1"
            }
        }
    }
    ```

1. 在边栏选项卡顶部，单击 **“保存”**。

现在已经设置好环境，是时候生成我们的设备证书了。

### 练习 5：模拟设备

在本练习中，你将从根证书生成 X.509 证书。然后，你将在控制台应用程序中使用这些证书，该应用程序将模拟连接到 DPS 并将遥测发送到 IoT 中心的 10 个设备。

#### 任务 1：生成设备证书

现在，你将生成并下载 10 个设备证书。

1. 打开 [“Azure Cloud Shell”](https://shell.azure.com/)并使用本课程使用的 Azure 订阅登录。

1. 在 Cloud Shell 命令提示符下，要创建名为 **“monitoring”** 的目录并移至该目录中，请输入以下命令：

    ```bash
    mkdir monitoring
    cd monitoring
    ```

1. 若要创建将在其中复制设备生成脚本的空文件，请输入以下命令：

    ```bash
    touch gen-dev-certs.sh
    chmod +x gen-dev-certs.sh
    ```

1. 在 Cloud Shell 工具栏上，单击 **“打开编辑器”**。

    用来打开 Cloud Shell 编辑器的按钮是 **“{ }”** 图标，即右数第二个。

1. 在 **“文件”** 选项下，要编辑 “gen-dev-certs.sh” 文件的内容，请单击 **“监视”**，然后单击 **“gen-dev-certs.sh”** 

    **gen-dev-certs.sh** 文件当前为空。

1. 将以下代码粘贴到云编辑器中。

    ```bash
    #!/bin/bash

    ＃生成 10 个设备证书
    ＃为每个设备重命名
    ＃从 Cloud CLI 下载
    pushd ~/certificates
    for i in {1..10}
    do
        chmod +w ./certs/new-device.cert.pem
        ./certGen.sh create_device_certificate asset-track$i
        睡眠 5 秒
        cp ./certs/new-device.cert.pfx ./certs/new-asset-track$i.cert.pfx
        download ./certs/new-asset-track$i.cert.pfx
    done
    popd
    ```

    该脚本将创建并下载 10 个设备证书。

1. 要保存已编辑的 **“gen-dev-certs.sh”** 文件，请按 **CTRL-Q**。 

    如果在关闭编辑器之前提示保存更改，请单击 **“保存”**。

1. 在 Cloud Shell 命令提示符处，要运行 **“gen-dev-certs.sh”** 脚本，输入以下命令：

    ```bash
    ./gen-dev-certs.sh
    ```

    脚本运行时，你将看到证书生成器的输出，然后浏览器将依次自动下载各个证书。 

    > **注释**：如果浏览器询问要对文件执行什么操作，请为每个文件单击 **“保存”**。


    完成后，你的浏览器下载位置将提供 10 个证书：

    * new-asset-track1.cert.pfx
    * new-asset-track2.cert.pfx
    * new-asset-track3.cert.pfx
    * new-asset-track4.cert.pfx
    * new-asset-track5.cert.pfx
    * new-asset-track6.cert.pfx
    * new-asset-track7.cert.pfx
    * new-asset-track8.cert.pfx
    * new-asset-track9.cert.pfx
    * new-asset-track10.cert.pfx

获取这些证书后，即可开始配置设备模拟器。

#### 任务 2：将证书添加到模拟器

1. 将所下载的 **“X.509 设备证书”** 文件复制到实验室 17 **“Starter”** 文件夹。

    在_实验室 3 中：设置开发环境_，你可以通过下载 ZIP 文件并从本地提取内容来克隆包含实验室资源的 GitHub 存储库。提取的文件夹结构包括以下文件夹路径：

    * Allfiles
      * 实验室
          * 17 - 如何管理 Azure IoT 中心
            * Starter

    实验室 17 的 Starter 文件夹包含 SimulatedDevice.csproj 和 Program.cs 文件。在向设备预配服务进行身份验证时，项目将需要访问此证书文件。这些文件需要位于项目文件夹的根目录下：

    复制后，证书文件将位于以下位置：

    ```text
    /Starter/new-asset-track1.cert.pfx
    /Starter/new-asset-track2.cert.pfx
    /Starter/new-asset-track3.cert.pfx
    /Starter/new-asset-track4.cert.pfx
    /Starter/new-asset-track5.cert.pfx
    /Starter/new-asset-track6.cert.pfx
    /Starter/new-asset-track7.cert.pfx
    /Starter/new-asset-track8.cert.pfx
    /Starter/new-asset-track9.cert.pfx
    /Starter/new-asset-track10.cert.pfx
    ```

1. 打开 Visual Studio Code。

1. 在 **“文件”** 菜单上，单击 **“打开文件夹”**。

1. 在 **“打开文件夹”** 对话框中，导航到实验室 17 的“Starter”文件夹，单击 **“Starter”**，然后单击 **“选择文件夹”**。

    > **注释**：如果 Visual Studio Code 建议加载资产或执行还原，请遵循建议。
 
1. 在 **“资源管理器”** 窗格中，请单击 “Program.cs” 打开 **“Program.cs”** 文件。

    你还会看到列出的证书文件。

1. 在代码编辑器中，找到 `GlobalDeviceEndpoint` 变量。

    注意，其值设为 `global.azure-devices-provisioning.net`。这是公共 Azure 云中 Azure 设备预配服务 (DPS) 的 **“全局设备终结点”**。连接到 Azure DPS 的所有设备都将使用此全局设备终结点 DNS 名称进行配置。

    ```csharp
    private const string GlobalDeviceEndpoint = "global.azure-devices-provisioning.net";
    ```

1. 找到 `dpsIdScope` 变量。

    ```csharp
    private static string dpsIdScope = "<DPS-ID-Scope>";
    ```

    你需要将 `<DPS-ID-Scope>` 占位符值替换为实际值。

1. 返回到显示包含 Azure Cloud Shell 的浏览器窗口。

1. 在 Cloud Shell 命令提示符下，请输入以下命令显示 DPS 服务的 ID 范围：

    ```bash
    az iot dps show --name AZ-220-DPS-{YOUR-ID} --query properties.idScope
    ```

    > **注释**：请务必将 {YOUR-ID} 替换为你在本课程开始时创建的 ID

1. 复制该命令的输出

1. 返回 Visual Studio Code。

1. 将 `<DPS-ID-Scope>` 值替换为从 Azure Cloud Shell 复制的值。

   ```csharp
   private static string dpsIdScope = "0ne000A6D9B";
   ```

该应用与之前在实验室 **L06-DPS 设备的自动注册** 中使用的应用非常相似。主要区别在于，它并不仅仅是注册一个设备模拟器然后发送遥测，而是注册 10 个设备，每 30 秒注册一个。然后，每个模拟设备将发送遥测。这将触发警报，并将监视数据记录到存储中。

#### 任务 3：运行模拟器

1. 在 Visual Studio Code 中，单击 **“终端”** 菜单上的 **“新建终端”**。

1. 在终端命令提示符下，请输入以下命令运行该应用：

    ```bash
    dotnet run
    ```

    你应该会看到显示第一个设备正通过 DPS 连接，然后发送遥测的输出。此后每隔 30 秒，将连接其他设备并开始发送遥测，直到所有 10 个设备均已连接并发送遥测。

1. 返回到 Azure 门户中的 DPS 组注册。

1. 在 **“模拟设备”** 注册组中，要查看连接的设备，请单击 **“注册记录”**。

    你应该会看到已连接设备的列表。你可以点击 **“刷新”** 以更新列表。

    现在，你已连接设备并发送遥测，一旦连接 5 个或更多设备的时间长达 5 分钟，就可以等待警报触发。你应该会收到一条类似于以下内容的短信：

    ```text
    AZ220EmailAG:Fired:Sev3 Azure Monitor Alert Connected Devices Greater or Equal to 5 on <your IoT Hub>
    ```

1. 收到警报后，你就可以退出应用程序。

    你可以在 Visual Studio Code 终端中按 **“CTRL+C”**，或者关闭 Visual Studio Code。

    > **注释**：  设备断开连接后，你将收到消息，告知警报已解决。

现在应该检查存储帐户，并查看 Azure Monitor 是否已记录任何内容。

### 练习 6：查看指标、警报和存档

在本练习中，你将检查之前在本实验室中配置的一些报告和日志记录资源，并查看在过去的短时间内记录的事件数据。

#### 任务 1：在门户中查看指标

1. 在 Azure 门户中，单击图表标题，以打开固定到仪表板的“指标”图表。

    图表将打开并在页面上显示。

1. 将时间值更改为 **“最近 30 分钟”**。

    请注意，你可以看到 *“已发送的遥测消息”* 和 *已连接设备（预览）**值，最新数字位于图表底部，将鼠标指针悬停在图表上即可查看特定时间点的值。

#### 任务 2：查看警报

若要使用 Azure 门户查看警报，请完成以下步骤。

1. 在 Azure 门户中，导航回你的仪表板。

1. 在 Azure 门户工具栏的搜索框中，键入 **“monitor”**

1. 在搜索结果窗格的 **“服务”** 下，单击 **“监控器”**。

    此时将显示 **“监控器 - 概述”** 页面。这是当前订阅的所有监控活动的概述。

1. 在左侧导航菜单中的列表顶部附近，单击 **“警报”**。

    此警报视图显示所有订阅的所有警报。让我们将此过滤到 IoT 中心。

1. 在边栏选项卡顶部附近的 **“订阅”** 下，选择用于该课程的订阅。

1. 在 **“资源组”** 下拉列表中，单击 **“AZ-220-RG”**。

1. 在 **“资源”** 下拉列表中，单击 **“AZ-220-HUB-{YOUR-ID}”**。

1. 在 **“时间范围”** 下拉列表中，单击 **“过去一个小时”**。

    现在，你应该会看到过去一小时的警报摘要。在 **“总警报规则”** 下，你应该会看到 **“1”**，即你之前创建的警报。在下面，你将看到严重性类别的列表以及每个类别的警报计数。我们感兴趣的警报是 **严重性 3**。你应该至少看到一个（如果已停止并重新启动设备模拟器，则可能会生成多个警报）。

1. 在严重性列表中，单击 **“严重性 3”**。

    **“所有警报”** 页面将会打开。在页面顶部，你会看到许多筛选器字段 - 这些字段已填充上一屏幕中的值，因此仅显示所选 IoT 中心的 **“严重性 3”** 警报。它将显示活动的警报以及任何警告。

1. 在 **“名称”** 下，要选择“严重性 3”警报，请单击 **“所连接设备大于或等于 5 个”**。

    将打开一个窗格，显示警报详细信息的 **“摘要”**。其中包括一个说明警报触发原因的图表，虚线标示了受监视指标的阈值以及当前值。以下是 **“条件”** 的详细信息和其他详细信息。

1. 在窗格顶部，单击标题下方的 **“历史记录”**。

    在此视图中，可以看到警报触发时间、调用的操作组以及任何其他更改，例如警报解决时间等。

1. 在窗格顶部，单击标题下方的 **“诊断”**。

    如果存在与警报相关的任何问题，则会在此处显示其他详细信息。

#### 任务 3：查看诊断日志

在本实验的前面部分，你将设置诊断日志以导出到 Blob 存储。现在是检查并查看所写内容的好时机。

1. 导航到仪表板，然后找到 “AZ-220-RG” 资源组磁贴。

1. 在资源列表中，选择之前创建的存储帐户 **(az220storage{your-id})**。

    将会显示该存储帐户的 **“概述”**。

1. 向下滚动，直到你可以看到存储帐户的指标图表：*总出口*、*总入口*、*平均延迟*和*要求明细*。

    你应该看到显示了活动。

1. 在左侧的导航菜单上，要查看已记录的数据，请单击 **“存储资源管理器（预览版）”**。

1. 在 **“存储资源管理器”** 窗格中，展开 **“BLOB 容器”** 节点。

    当 Azure Monitor 首次将数据发送到存储帐户时，它将创建一个名为 **“insights-logs-connection”** 的容器。

1. 在 **“BLOB 容器”** 下，单击 **“insights-logs-connection”**。

    容器的内容将在右侧列出。

    日志以非常嵌套的方式写入容器。你将需要依次打开每个子文件夹以导航到实际的日志数据。结构类似于以下所示：

    * **resourceId=**
      * **SUBSCRIPTIONS**
        * **<GUID>** - 这是生成日志的订阅的 ID
          * **RESOURCEGROUPS** - 包含每个生成日志的资源组的文件夹
            * "AZ-220-RG" - 包含 IoT 中心的资源组
              * **PROVIDERS**
                * **MICROSOFT.DEVICES**
                  * **IOTHUBS**
                    * **AZ-220-HUB-{YOUR-INITIALS-AND-CURRENT-DATE}** -  包含用于生成日志的文件夹，每年一个文件夹
                      * **Y=2019** -  包含用于日志生成的文件夹，每月一个文件夹
                        * **m=12** -  包含每天的文件夹，用作日志生成位置
                          * **d=15** -  包含每小时的文件夹，用作日志生成位置
                            * **h=15** -  包含每分钟的文件夹，用作日志生成位置
                              * **m=00** -  包含该分钟的日志文件

    向下钻取直到获得当前日期，然后选择最新文件。

1. 选中文件后，在窗格顶部的工具栏上，单击 **“下载”**。

1. 在 Visual Studio Code 中打开已下载的文件。

    你应该会看到几行 JSON。

1. 要使 JSON 更易读取，请按 **F1**，输入 **“设置文档格式”**，然后从选项列表中选择 **“设置文档格式”**。

    JSON 将显示连接和断开连接事件的列表，类似于：

    ```json
    {
        "time": "2019-12-26T14:32:45Z",
        "resourceId": "/SUBSCRIPTIONS/AE82FF3B-4BD0-462B-8449-D713DD18E11E/RESOURCEGROUPS/AZ-220/PROVIDERS/MICROSOFT.DEVICES/IOTHUBS/AZ-220-HUB-DM121619",
        "operationName": "deviceConnect",
        "category": "Connections",
        "level": "Information",
        "properties": "{\"deviceId\":\"asset-track9\",\"protocol\":\"Amqp\",\"authType\":\"{\\\"scope\\\":\\\"device\\\",\\\"type\\\":\\\"x509Certificate\\\",\\\"issuer\\\":\\\"external\\\",\\\"acceptingIpFilterRule\\\":null}\",\"maskedIpAddress\":\"67.176.115.XXX\",\"statusCode\":null}",
        "location": "westus"
    }
    {
        "time": "2019-12-26T14:33:12Z",
        "resourceId": "/SUBSCRIPTIONS/AE82FF3B-4BD0-462B-8449-D713DD18E11E/RESOURCEGROUPS/AZ-220/PROVIDERS/MICROSOFT.DEVICES/IOTHUBS/AZ-220-HUB-DM121619",
        "operationName": "deviceConnect",
        "category": "Connections",
        "level": "Information",
        "properties": "{\"deviceId\":\"asset-track10\",\"protocol\":\"Amqp\",\"authType\":\"{\\\"scope\\\":\\\"device\\\",\\\"type\\\":\\\"x509Certificate\\\",\\\"issuer\\\":\\\"external\\\",\\\"acceptingIpFilterRule\\\":null}\",\"maskedIpAddress\":\"67.176.115.XXX\",\"statusCode\":null}",
        "location": "westus"
    }
    {
        "time": "2019-12-26T14:37:29Z",
        "resourceId": "/SUBSCRIPTIONS/AE82FF3B-4BD0-462B-8449-D713DD18E11E/RESOURCEGROUPS/AZ-220/PROVIDERS/MICROSOFT.DEVICES/IOTHUBS/AZ-220-HUB-DM121619",
        "operationName": "deviceDisconnect",
        "category": "Connections",
        "level": "Information",
        "properties": "{\"deviceId\":\"asset-track8\",\"protocol\":\"Amqp\",\"authType\":null,\"maskedIpAddress\":\"67.176.115.XXX\",\"statusCode\":null}",
        "location": "westus"
    }
    {
        "time": "2019-12-26T14:37:29Z",
        "resourceId": "/SUBSCRIPTIONS/AE82FF3B-4BD0-462B-8449-D713DD18E11E/RESOURCEGROUPS/AZ-220/PROVIDERS/MICROSOFT.DEVICES/IOTHUBS/AZ-220-HUB-DM121619",
        "operationName": "deviceDisconnect",
        "category": "Connections",
        "level": "Information",
        "properties": "{\"deviceId\":\"asset-track4\",\"protocol\":\"Amqp\",\"authType\":null,\"maskedIpAddress\":\"67.176.115.XXX\",\"statusCode\":null}",
        "location": "westus"
    }
    ```

    请注意，每个条目都是一个 JSON 记录，但整个文档不是有效的 JSON 文档。在每个记录中，可以查看与始发 IoT 中心相关的详细信息以及每个事件的 **“属性”**。在 **“属性”** 对象内，可以看到正在连接（或正在断开连接）的 **“deviceId”**。
